<form [formGroup]="ProductItem">
  <div class="ui-g">
    <div class="ui-g-10">
      <div class="ui-g-12 ui-md-3">
        <div class="le-su-3">
          <label for="lbBrand" class="towlable fwLabelBold"><strong>Action</strong><span class="star">
              *</span></label>
          <div>
            <p-dropdown [filter]="true" (onChange)="onChange_Action(ProductItem)" id="taskAction" class="clsControl"
              tabindex="{{tabindexcount * (iA + 1) + 3 }}" [options]="actionNameValue" placeholder="--Select--"
              formControlName="taskAction">
            </p-dropdown>
          </div>

        </div>
      </div>
      <div class="ui-g-12 ui-md-9">
        <div class="le-su-9">
          <div clss="clear"><br></div>
          <div *ngIf="ProductItem.controls.taskAction.value === 'None'">
            <span style="color: salmon">
              Warning: Extra products created will not be accessable after completion.
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="ui-g-11" formArrayName="tasksArr" *ngIf="actionType === 'ReleaseMaterial'">
      <p-table [value]="tasksArr?.controls" id="tblCreateTask" name="tblCreateTask"
        styleClass="clsTableWithoutCss clsTable" [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width:17%;">Task Type</th>
            <th style="width:14%;">Task Status</th>
            <th style="width:15%;">Employee </th>
            <th style="width:10%;">Assigned</th>
            <th style="width:15%;">Release Qty</th>
            <th style="width:20%;">Select Items</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-taskArrayItem let-i="rowIndex">
          <tr [formGroupName]="i">
            <td> {{taskArrayItem.value.taskTypeName}} </td>
            <td> {{taskArrayItem.value.taskStatus}} </td>
            <td> {{taskArrayItem.value.employeeName}} </td>
            <td> {{taskArrayItem.value.assignedQty}} units </td>
            <td>
              <span *ngIf="ProductItem.controls.taskCount.value > 1 ; else taskcount_content">
                <div>

                  <input pInputText name="releaseQty" maxLength="10" pKeyFilter="num" tabindex="1" id="releaseQty"
                    OnlyNumber="true" autocomplete="off" type="number" PositiveIntegers OnlyNumberWithoutZero="true"
                    (change)="addedQty_onChange(taskArrayItem, taskArrayItem.value.assignedQty, ProductItem.value.orderedQty)" class="clsControl"
                    formControlName="releaseQty" />
                </div>
                <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                  *ngIf="!taskArrayItem.controls['releaseQty'].valid&&taskArrayItem.controls['releaseQty'].dirty">
                  <span *ngIf="taskArrayItem.controls['releaseQty'].errors['required']">
                    required
                  </span>
                  <span *ngIf="taskArrayItem.controls['releaseQty'].hasError('assignedQtyExceeded')">
                    Weight exceeded.
                  </span>
                </div>
              </span>
              <ng-template #taskcount_content>
                <div>
                  {{ absValue(taskArrayItem.value.releaseQty)}} units
                </div>
              </ng-template>
            </td>
            <td>


                <div>
                    <span  *ngIf="ProductItem.value.skewkeyName !== 'BUD'">
                        <span
                          *ngIf="taskArrayItem.value.isSameLot && taskArrayItem.controls['releaseQty'].value > 0 ; else taskSelectLot123_content">
                          Same Lot
                        </span>
                        <ng-template #taskSelectLot123_content>
                        <span  *ngIf="taskArrayItem.controls['releaseQty'].value > 0 ; else taskSelectLotProductItem_content" >
                            <a 
                            class="btn-link anchor"
                            [class.clsLotSelected]="selectedPkgsArray[i]?.length"
                            [routerLink]="" 
                            (click)="openPkgSelection(ProductItem, taskArrayItem, i)"
                             > 
                              <span *ngIf="!selectedPkgsArray[i]?.length">  
                                Select Lots
                                 </span>
                                <span *ngIf="selectedPkgsArray[i]?.length">
                                 View/Change Lots
                                </span>   
                              </a>
                    </span>
                    <ng-template #taskSelectLotProductItem_content>
                        <div>
                          Select Lots
                        </div>
                      </ng-template>
                      </ng-template>
                      </span>
                      <span *ngIf="ProductItem.value.skewkeyName === 'BUD'">
                        <span
                          *ngIf="taskArrayItem.value.isSameLot && taskArrayItem.controls['releaseQty'].value > 0 ; else taskSelectLot12_content">
                          Same Lot
                        </span>
                        <ng-template #taskSelectLot12_content>
                          <span *ngIf="  taskArrayItem.controls['releaseQty'].value > 0 ; else taskSelectLot1_content">
                            <a class="btn-link anchor"
                              [class.clsLotSelected]="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0" [routerLink]=""
                              (click)="openLotSelection(ProductItem, taskArrayItem, i)">
                              <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length <= 0">
                                Select Lots
                              </span>
                              <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0">
                                View/Change Lots
                              </span>
                            </a>
                      
                            <!-- <a class="btn-link anchor" [routerLink]=""
                                            (click)="openLotSelection(ProductItem, taskArrayItem, i)">
                                            Select Items
                                          </a> -->
                          </span>
                          <ng-template #taskSelectLot1_content>
                            <div>
                              Select Items
                            </div>
                          </ng-template>
                        </ng-template>
                      </span>
                </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td> </td>
            <td> </td>
            <td> </td>
            <td> </td>
            <td colspan="2">
              <div>
                <span style="color: salmon">

                  {{addtionAssignedQty}}/{{absValue(ProductItem.value.orderedQty - ProductItem.value.totalAssignedQty)}}
                  units released.
                </span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>



  <p-dialog header="Select Lots" [(visible)]="showLotSelectionModel" modal="modal" [resizable]="true"
    [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true">

    <form [formGroup]="questionForm" (ngSubmit)="submit(questionForm)" formSubmit>

      <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">

        <div class="ui-g">
          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>{{globalResource.genetics}}:</strong>
            </label>

            <label>
              {{ selLotBrandStrainRow?.GeneticsName }}
            </label>
          </div>

          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>Release Weight:</strong>
            </label>

            <label>
              {{ selLotBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
            </label>
          </div>

        </div>
        <div formArrayName="questions">
          <p-table [value]="questions?.controls" id="tblLotSelection">
            <ng-template pTemplate="header">
              <tr>
                <th style="width:150px">{{globalResource.strain}}</th>
                <th style="width:170px">{{globalResource.lotno}}</th>
                <th style="width:33.33333333%">Assigned Wt</th>
                <th style="width:33.33333333%">Release Wt</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-question let-i="rowIndex">
              <tr [formGroupName]="i">
                <td style="width: 150px"> {{ brandStrainLots[i].StrainName  }}</td>
                <td style="width: 170px">
                  <!-- <p-checkbox
                      label="{{ brandStrainLots[i].GrowerLotNo  }}"
                      formControlName="question"
                      (ngModelChange)="changeValidator($event, i)"
                      binary="true"
                    ></p-checkbox> -->
                  <label>{{ brandStrainLots[i].GrowerLotNo  }}</label>

                  <app-lot-comment [LotId]="question.value.LotNo" [LotCommentsCount]="brandStrainLots[i].LotNoteCount"
                    (CommentIconClicked)="commentIconClicked($event)"></app-lot-comment>

                  <app-lot-note-icon [LotId]="question.value.LotNo" (NoteIconClicked)="showLotNote($event)">
                  </app-lot-note-icon>

                </td>

                <td>

                  {{ question.value.SelectedWt  }} {{globalResource.listgramunit}}
                  <!-- <ng-container *ngIf="taskId && taskId > 0">
                  
                    {{ question.value.SelectedWt  }} {{globalResource.listgramunit}}
                  </ng-container>

                  <ng-container *ngIf="!taskId">
                    {{ lotSyncWtArr.has(brandStrainLots[i].LotId) 
                        ? getLotSyncWt(brandStrainLots[i].LotId)
                        :  question.value.AvailWt }} {{globalResource.listgramunit}}
                  </ng-container> -->
                </td>
                <td>
                  <input type="number" (change)="lotWeightOnChange(question)" OnlyNumber="true" pInputText
                    pKeyFilter="pnum" autocomplete="off" formControlName="answer" id="answer" name="answer"
                    style="width:100%;" />
                  <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                    *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                    <span
                      *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                      {{assignTaskResources.errSelectValidWeight}}
                    </span>
                    <span *ngIf="question.controls['answer'].errors['required']" style="width:120px">
                      {{assignTaskResources.errWeightRequired}}
                    </span>

                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
              <tr>
                <td [attr.colspan]="3">
                  {{ assignTaskResources.nolotpresent }} "{{ selLotBrandStrainRow?.StrainName }}".
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      <p-footer class="text-right">

        <button type="submit" pButton icon="fa-check" label="Confirm" id="btnLotSelectionConfirm"
          name="btnLotSelectionConfirm"></button>

        <button type="button" pButton icon="fa-close" (click)="showLotSelectionModel=false" label="Cancel"></button>
      </p-footer>
    </form>
  </p-dialog>

   <!--Select Packages For Order select package model-->
   <p-dialog header="Select Pkgs"
   [(visible)]="showPkgSelectionModel"
   modal="modal"
   [resizable]="true"
   [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true" >

     <form [formGroup]="questionPkgForm" (ngSubmit)="submitPkg(questionPkgForm)" formSubmit>
   <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">

     <div class="ui-g">
         <div class="ui-g-12 ui-md-6">
             <label>
                 <strong>Genetics</strong>
               </label>

               <label> 
                 {{ selPkgBrandStrainRow?.GeneticsName }}
               </label>
           </div>
             <!-- <div class="ui-g-12 ui-md-6">
                 <label>
                   <strong>Strain</strong>
                 </label>

                 <label>
                   {{ selPkgBrandStrainRow?.StrainName }}
                 </label>
               </div> -->

               <div class="ui-g-12 ui-md-6">
                   <label>
                     <strong>Required Weight</strong>
                   </label>

                   <label>
                     {{ selPkgBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
                   </label>
                 </div>

       </div>
       <div formArrayName="pkgQuestions">
       <p-table [value]="pkgQuestions?.controls">
           <ng-template pTemplate="header">
               <tr>
                   <th style="width:20%">Strain</th>
                   <th style="width:20%">Oil Pkg Code</th>
                   <th style="width:20%">TP Pkg. Type</th>
                   <th style="width:20%">Avail. Oil Wt.</th>
                   <th style="width:20%">Selected Weight</th>
               </tr>
           </ng-template>
           <ng-template pTemplate="body" let-question let-i="rowIndex" >
               <tr [formGroupName]="i">
                   <td> {{ brandStrainPkgs[i].StrainName  }}</td>
                   <td>
                       <label>{{ brandStrainPkgs[i].OilPkgCode  }}</label>
                   </td>
                   <td> {{ brandStrainPkgs[i].TPPkgTypeName  }}</td>
                    <td> 
                        {{ question.value.SelectedWt  }} {{globalResource.listgramunit}} 
                   </td>
                   
                   <td>
                     <input
                       pKeyFilter="pnum"
                       type="number"
                       OnlyNumber="true"
                       pInputText
                       autocomplete="off"
                       formControlName="answer"
                       id="answer"
                       name="answer"
                       (change)= "pkgWeightOnChange(question)"
                       style="width:100%;"
                   />
                   <div
                     class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                     *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                       <span *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                         Select Valid Weight
                       </span>  
                       <span *ngIf="question.controls['answer'].errors['required']">
                         Required
                       </span>
                       <span *ngIf="question.controls['answer'].hasError('oilpkgmaxwtexceeded')">
                         max lot wt exceeded 
                       </span>
                   </div>
                 </td>
               </tr>
           </ng-template>
           <ng-template pTemplate="emptymessage" let-columns>
             <tr>
                 <td [attr.colspan]="5">
                     Sorry, No package is present against "{{ selPkgBrandStrainRow?.StrainName }}".
                 </td>
             </tr>
           </ng-template>
       </p-table>
       </div>
       
     </div>
     <p-footer class="text-right">

       <button type="submit" pButton icon="fa-check"  label="Confirm" ></button>
       <!-- [disabled]="questionForm.invalid" -->
       <button type="button" pButton icon="fa-close" (click)="showPkgSelectionModel=false" label="Cancel"></button>
   </p-footer>
 </form>
 </p-dialog>
</form>
<app-lot-note [Lot]="lotInfo" *ngIf="lotInfo?.showLotNoteModal" (NoteSaved)="onNoteSave($event)"></app-lot-note>

<app-popup-lot-comment [Lot]="lotInfo" *ngIf="lotInfo?.showLotCommentModal" (CommentSaved)="OnCommentSaved($event)">
</app-popup-lot-comment>

<p-growl [(value)]="msgs" life='5000'></p-growl>