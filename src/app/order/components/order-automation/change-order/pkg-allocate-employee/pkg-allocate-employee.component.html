<form [formGroup]="ProductItem">
  <div class="ui-g" >
      <div class="ui-g-10"  >
          <div class="ui-g-12 ui-md-3">
              <div class="le-su-3">
                <label for="lbBrand" class="towlable fwLabelBold"><strong>Action</strong><span class="star">
                    *</span></label>
                <div>
                  <p-dropdown [filter]="true"
                    (onChange)="onChange_Action(ProductItem)"
                    id="taskAction" class="clsControl" tabindex="{{tabindexcount * (iA + 1) + 3 }}"
                    [options]="actionNameValue" placeholder="--Select--" formControlName="taskAction">
                  </p-dropdown>
                </div>
  
              </div>
            </div>
            <div class="ui-g-12 ui-md-9">
                <div class="le-su-9">
                  <div clss="clear"><br></div>
                  <div *ngIf="ProductItem.controls.taskAction.value === 'None'">
                    <span style="color: salmon">
                      Warning: Tasks will need to be manually assigned for this item.
                    </span>
                  </div>
                </div>
              </div>
      </div>

    <div class="ui-g-11" formArrayName="tasksArr" *ngIf="actionType === 'CreateTask'">
      <p-table [value]="tasksArr?.controls" id="tblCreateTask" name="tblCreateTask"
        styleClass="clsTableWithoutCss clsTable" [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width:20%;">Task Type</th>
            <th style="width:15%;">Task Status</th>
            <th style="width:15%;">Employee<span class="star">*</span></th>
            <th style="width:10%;">Assign Qty</th>
            <th style="width:15%;">Select Lot(s)</th>
            <th style="width:30px;"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-taskArrayItem let-i="rowIndex">
          <tr [formGroupName]="i">
            <td> {{ProductItem.controls.taskName.value}} </td>
            <td>To Be Assigned </td>
            <td>
              <div>
                <p-dropdown [filter]="true" (onChange)="onChange_Employee(taskArrayItem)" id="employee"
                  class="clsControl" tabindex="2" [options]="employees" placeholder="--Select--"
                  formControlName="employee">
                </p-dropdown>
              </div>
              <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                *ngIf="!taskArrayItem.controls['employee'].valid&&taskArrayItem.controls['employee'].dirty">
                <span *ngIf="taskArrayItem.controls['employee'].hasError('duplicateemployee')">
                  same emplyee for task.
                </span>
              </div>
            </td>
            <td>
              <div>
                <input pInputText name="assignedQty" maxLength="10" pKeyFilter="num" tabindex="1" id="assignedQty"
                  OnlyNumber="true" autocomplete="off" type="number"
                  (change)="assognedQty_onChange(taskArrayItem, ProductItem.value.unassignedQty)" class="clsControl"
                  formControlName="assignedQty" />
              </div>
              <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                *ngIf="!taskArrayItem.controls['assignedQty'].valid&&taskArrayItem.controls['assignedQty'].dirty">
                <span *ngIf="taskArrayItem.controls['assignedQty'].hasError('assignedQty')">
                  <!-- Sum must equal Total(-{{rowData.controls['assignQty'].errors['greaterQty'].totalAssigedQty - rowData.controls['assignQty'].errors['greaterQty'].totalRequiredQty }}) -->
                  <span *ngIf="taskArrayItem.controls['assignedQty'].errors['required']">
                    required
                  </span>
                  <span *ngIf="taskArrayItem.controls['assignedQty'].hasError('assignedQtyExceeded')">
                    Weight exceeded.
                  </span>
                </span>
              </div>
            </td>
            <td>
              <div>
                <span *ngIf="taskArrayItem.controls['assignedQty'].value > 0 ; else taskSelectLot2_content ">
                  <a class="btn-link anchor" [routerLink]="" (click)="openLotSelection(ProductItem, taskArrayItem, i)">
                    Select Lots
                  </a>
                </span>
                <ng-template #taskSelectLot2_content>
                    <span >
                      Select Lots
                    </span>
                  </ng-template>
                </div>
            </td>
            <td> <span *ngIf="i>=1">
                <a href="#" [routerLink]="" (click)="deleteItem(i)">
                  <span style="font-size: 1.4rem;" class="fa fa-trash">
                  </span>
                </a>
              </span> </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td>
              <div>
                <a [routerLink]="" (click)="createNewTask('CreateTask')"
                  style="text-decoration: underline;float: left;color: #337ab7">Create New Task</a>
              </div>
            </td>
            <td>

            </td>
            <td>

            </td>
            <td colspan="2">
              <div>
                <span style="color: salmon">
                  {{addtionAssignedQty}}/{{ProductItem.value.orderedQty}} units assigned
                </span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- ADd to current task -->
    <div class="ui-g-11" formArrayName="tasksArr" *ngIf="actionType === 'AddToCurrentTask'">
      <p-table [value]="tasksArr?.controls" id="tblCreateTask" name="tblCreateTask"
        styleClass="clsTableWithoutCss clsTable" [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width:17%;">Task Type</th>
            <th style="width:14%;">Task Status</th>
            <th style="width:15%;">Employee <span class="star">*</span></th>
            <th style="width:10%;">Assigned</th>
            <th style="width:10%;">Add Qty</th>
            <th style="width:20%;">Select Lot(s)</th>
            <th style="width:20px;"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-taskArrayItem let-i="rowIndex">
          <tr [formGroupName]="i">
            <td> {{ProductItem.controls.taskName.value}} </td>
            <td>
              <div *ngIf="taskArrayItem.value.taskId  ; else taskstatus_content">
                {{taskArrayItem.value.taskStatus}} </div>
              <ng-template #taskstatus_content>
                <div>
                  To Be Assigned
                </div>
              </ng-template>
            </td>
            <td>
              <div>

                <div *ngIf="taskArrayItem.value.taskId   ; else employee_content">
                  {{taskArrayItem.value.employeeName}}
                </div>
                <ng-template #employee_content>
                  <div>
                    <p-dropdown [filter]="true" (onChange)="onChange_Employee(taskArrayItem)" id="employee"
                      class="clsControl" tabindex="2" [options]="employees" placeholder="--Select--"
                      formControlName="employee">
                    </p-dropdown>
                  </div>
                  <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                    *ngIf="!taskArrayItem.controls['employee'].valid&&taskArrayItem.controls['employee'].dirty">
                    <span *ngIf="taskArrayItem.controls['employee'].hasError('duplicateemployee')">
                      same emplyee for task.
                    </span>
                  </div>
                </ng-template>
              </div>
            </td>
            <td>
              <div>
                <div *ngIf="taskArrayItem.value.taskId ; else assignedQty_content">
                  {{taskArrayItem.value.assignedQty}} {{taskArrayItem.value.pkgTypeName}}
                </div>
                <ng-template #assignedQty_content>
                  <div>
                    <span>N/A</span>
                  </div>
                </ng-template>

              </div>
            </td>
            <td>
              <div>
                <input pInputText name="addedQty" maxLength="10" pKeyFilter="num" tabindex="1" id="addedQty"
                  OnlyNumber="true" autocomplete="off" type="number"
                  (change)="addedQty_onChange(taskArrayItem, ProductItem.value.unassignedQty)" class="clsControl"
                  formControlName="addedQty" />
              </div>
              <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                *ngIf="!taskArrayItem.controls['addedQty'].valid&&taskArrayItem.controls['addedQty'].dirty">
                <!-- <span *ngIf="taskArrayItem.controls['addedQty'].hasError('assignedQty')"> -->
                <!-- Sum must equal Total(-{{rowData.controls['assignQty'].errors['greaterQty'].totalAssigedQty - rowData.controls['assignQty'].errors['greaterQty'].totalRequiredQty }}) -->
                <span *ngIf="taskArrayItem.controls['addedQty'].errors['required']">
                  required
                </span>
                <span *ngIf="taskArrayItem.controls['addedQty'].hasError('assignedQtyExceeded')">
                  Weight exceeded.
                </span>
                <!-- </span> -->
              </div>
            </td>

            <td>
              <div> 
                    <span *ngIf="taskArrayItem.controls['addedQty'].value > 0 ; else taskSelectLot1_content">
                        <a 
                            class="btn-link anchor"
                            [class.clsLotSelected]="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0"
                            [routerLink]="" 
                            (click)="openLotSelection(ProductItem, taskArrayItem, i)"
                          > 
                            <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length <= 0">
                            Select Lots
                            </span>
                            <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0">
                             View/Change Lots
                            </span>
                          </a>
                    </span>
                    <ng-template #taskSelectLot1_content>
                      <div>
                        Select Lots
                      </div>
                    </ng-template>
              </div>
            </td>
            <td> <span *ngIf="i>=1">
                <a href="#" [routerLink]="" (click)="deleteItem(i)">
                  <span style="font-size: 1.4rem;" class="fa fa-trash">
                  </span>
                </a>
              </span> </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td>
              <div>
                <a [routerLink]="" (click)="createNewTask('AddToCurrentTask')"
                  style="text-decoration: underline;float: left;color: #337ab7">Create New Task</a>
              </div>
            </td>
            <td>

            </td>
            <td>

            </td>
            <td>
            </td>
            <td colspan="2">
              <div>
                <span style="color: salmon">
                  {{addtionAssignedQty}}/{{ProductItem.value.unassignedQty}} units assigned
                </span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

  </div>



  <p-dialog header="Select Lots" [(visible)]="showLotSelectionModel" modal="modal" [resizable]="true"
    [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true">

    <form [formGroup]="questionForm" (ngSubmit)="submit(questionForm)" formSubmit>

      <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">

        <div class="ui-g">
          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>{{globalResource.genetics}}:</strong>
            </label>

            <label>
              {{ selLotBrandStrainRow?.GeneticsName }}
            </label>
          </div>

          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>{{assignTaskResources.lblRequiredWeight}}:</strong>
            </label>

            <label>
              {{ selLotBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
            </label>
          </div>

        </div>
        <div formArrayName="questions">
          <p-table [value]="questions?.controls" id="tblLotSelection">
            <ng-template pTemplate="header">
              <tr>
                <th style="width:150px">{{globalResource.strain}}</th>
                <th style="width:170px">{{globalResource.lotno}}</th>
                <th style="width:33.33333333%">{{assignTaskResources.lblAvailWeight}}</th>
                <th style="width:33.33333333%">{{assignTaskResources.lblSelectedWeight}}</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-question let-i="rowIndex">
              <tr [formGroupName]="i">
                <td style="width: 150px"> {{ brandStrainLots[i].StrainName  }}</td>
                <td style="width: 170px">
                  <!-- <p-checkbox
                      label="{{ brandStrainLots[i].GrowerLotNo  }}"
                      formControlName="question"
                      (ngModelChange)="changeValidator($event, i)"
                      binary="true"
                    ></p-checkbox> -->
                  <label>{{ brandStrainLots[i].GrowerLotNo  }}</label>

                  <app-lot-comment [LotId]="question.value.LotNo" [LotCommentsCount]="brandStrainLots[i].LotNoteCount"
                    (CommentIconClicked)="commentIconClicked($event)"></app-lot-comment>

                  <app-lot-note-icon [LotId]="question.value.LotNo" (NoteIconClicked)="showLotNote($event)">
                  </app-lot-note-icon>

                </td>

                <td>
                  <ng-container *ngIf="taskId && taskId > 0">
                    {{ question.value.AvailWt  }} {{globalResource.listgramunit}}
                  </ng-container>

                  <ng-container *ngIf="!taskId">
                    <!-- {{ lotSyncWtArr.get(parseInt(brandStrainLots[i].LotId)) || 0 }} {{globalResource.listgramunit}} -->
                    {{ lotSyncWtArr.has(brandStrainLots[i].LotId) 
                        ? getLotSyncWt(brandStrainLots[i].LotId)
                        :  question.value.AvailWt }} {{globalResource.listgramunit}}
                  </ng-container>
                </td>
                <td>
                  <input type="number" (change)="lotWeightOnChange(question)" OnlyNumber="true" pInputText
                    pKeyFilter="pnum" autocomplete="off" formControlName="answer" id="answer" name="answer"
                    style="width:100%;" />
                  <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                    *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                    <span
                      *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                      {{assignTaskResources.errSelectValidWeight}}
                    </span>
                    <span *ngIf="question.controls['answer'].errors['required']" style="width:120px">
                      {{assignTaskResources.errWeightRequired}}
                    </span>
 
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
              <tr>
                <td [attr.colspan]="3">
                  {{ assignTaskResources.nolotpresent }} "{{ selLotBrandStrainRow?.StrainName }}".
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      <p-footer class="text-right">

        <button type="submit" pButton icon="fa-check" label="Confirm" id="btnLotSelectionConfirm"
          name="btnLotSelectionConfirm"></button>

        <button type="button" pButton icon="fa-close" (click)="showLotSelectionModel=false" label="Cancel"></button>
      </p-footer>
    </form>
  </p-dialog>
</form>
<app-lot-note [Lot]="lotInfo" *ngIf="lotInfo?.showLotNoteModal" (NoteSaved)="onNoteSave($event)"></app-lot-note>

<app-popup-lot-comment [Lot]="lotInfo" *ngIf="lotInfo?.showLotCommentModal" (CommentSaved)="OnCommentSaved($event)">
</app-popup-lot-comment>

<p-growl [(value)]="msgs" life='5000'></p-growl>