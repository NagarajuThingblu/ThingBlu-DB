<form [formGroup]="ProductItem">
  <div class="ui-g">
    <div class="ui-g-10">
      <div class="ui-g-12 ui-md-3">
        <div class="le-su-3">
          <label for="lbBrand" class="towlable fwLabelBold"><strong>Action</strong><span class="star">
              *</span></label>
          <div>
            <p-dropdown [filter]="true" (onChange)="onChange_Action(ProductItem)" id="taskAction" class="clsControl"
              tabindex="{{tabindexcount * (iA + 1) + 3 }}" [options]="actionNameValue" placeholder="--Select--"
              formControlName="taskAction">
            </p-dropdown>
          </div>

        </div>
      </div>
      <div class="ui-g-12 ui-md-9">
        <div class="le-su-9">
          <div clss="clear"><br></div>
          <div *ngIf="ProductItem.controls.taskAction.value === 'None'">
            <span style="color: salmon">
              Warning: Tasks will need to be manually assigned for this item.
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="ui-g-11" formArrayName="tasksArr" *ngIf="actionType === 'CreateTask'">
      <p-table [value]="tasksArr?.controls" id="tblCreateTask" name="tblCreateTask"
        styleClass="clsTableWithoutCss clsTable" [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width:20%;">Task Type</th>
            <th style="width:15%;">Task Status</th>
            <th style="width:15%;">Employee<span class="star">*</span></th>
            <th style="width:10%;">Assign Qty</th>
            <th style="width:15%;">Select Lot(s)</th>
            <th style="width:30px;"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-taskArrayItem let-i="rowIndex">
          <tr [formGroupName]="i">
            <td> {{ProductItem.controls.taskName.value}} </td>
            <td>To Be Assigned </td>
            <td>
              <div>
                <p-dropdown [filter]="true" (onChange)="onChange_Employee(taskArrayItem)" id="employee"
                  class="clsControl" tabindex="2" [options]="employees" placeholder="--Select--"
                  formControlName="employee">
                </p-dropdown>
              </div>
              <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                *ngIf="!taskArrayItem.controls['employee'].valid&&taskArrayItem.controls['employee'].dirty">
                <span *ngIf="taskArrayItem.controls['employee'].hasError('duplicateemployee')">
                  same emplyee for task.
                </span> 
                <span *ngIf="taskArrayItem.controls['employee'].errors['required']">
                 Please select employee.
                </span> 
                
              </div>
            </td>
            <td>
              <div>
                <input pInputText name="assignedQty" maxLength="10" pKeyFilter="num" tabindex="1" id="assignedQty"
                  OnlyNumber="true" autocomplete="off" type="number" PositiveIntegers OnlyNumberWithoutZero="true"
                  (change)="assognedQty_onChange(taskArrayItem, ProductItem.value.unassignedQty, i)" class="clsControl"
                  formControlName="assignedQty" />
              </div>
              <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                *ngIf="!taskArrayItem.controls['assignedQty'].valid&&taskArrayItem.controls['assignedQty'].dirty">
     
                  <span *ngIf="taskArrayItem.controls['assignedQty'].errors['required']">
                    required
                  </span>
                  <span *ngIf="taskArrayItem.controls['assignedQty'].hasError('assignedQtyExceeded')">
                    Weight exceeded.
                  </span>
                  <span *ngIf="taskArrayItem.controls['assignedQty'].hasError('min')">
                    Qty should 1 or more.
                   </span>
              </div>
            </td>
            <td>
              <div>
                <span *ngIf="ProductItem.value.skewkeyName === 'OIL'">
                  <span *ngIf="taskArrayItem.controls['assignedQty'].value > 0 && (ProductItem.value.orderedQty - addtionAssignedQty) >= 0  ; else taskSelectLotProductItem_content">
                    <a class="btn-link anchor" 
                      [class.clsLotSelected]="selectedPkgsArray.get(taskArrayItem.value.uniqueId)?.length > 0" 
                      [routerLink]=""
                      (click)="openPkgSelection(ProductItem, taskArrayItem, i)">
                      <span *ngIf="selectedPkgsArray.get(taskArrayItem.value.uniqueId)?.length <= 0">
                        Select Pkgs
                      </span>
                      <span *ngIf="selectedPkgsArray.get(taskArrayItem.value.uniqueId)?.length > 0">
                        View/Change Pkgs
                      </span>
                    </a>
                  </span>
                  <ng-template #taskSelectLotProductItem_content>
                    <div>
                      Select Pkgs
                    </div>
                  </ng-template>
                </span>
                <span *ngIf="ProductItem.value.skewkeyName === 'BUD' ">
                  <span *ngIf="taskArrayItem.controls['assignedQty'].value > 0 && (ProductItem.value.orderedQty - addtionAssignedQty) >= 0  ; else taskSelectLot2_content">
                    <a class="btn-link anchor"
                      [class.clsLotSelected]="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0"
                      [routerLink]="" (click)="openLotSelection(ProductItem, taskArrayItem, i)">
                      <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length <= 0">
                        Select Lots
                      </span>
                      <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0">
                        View/Change Lots
                      </span>
                    </a>
                  </span>
                  <ng-template #taskSelectLot2_content>
                    <div>
                      Select Lots
                    </div>
                  </ng-template>
                </span>
              </div>
            </td>
            <td> <span *ngIf="i>=1">
                <span
                  *ngIf="ProductItem.value.skewkeyName === 'BUD'  && taskArrayItem.value.taskStatus === 'ToBeAssigned'">
                  <a href="#" [routerLink]="" (click)="deleteItem(i, taskArrayItem)">
                    <span style="font-size: 1.4rem;" class="fa fa-trash">
                    </span>
                  </a>
                </span>
                <span
                  *ngIf="ProductItem.value.skewkeyName !== 'BUD'  && taskArrayItem.value.taskStatus === 'ToBeAssigned'">
                  <a href="#" [routerLink]="" (click)="deletePkgItem(i, taskArrayItem)">
                    <span style="font-size: 1.4rem;" class="fa fa-trash">
                    </span>
                  </a>
                </span>
              </span> </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td>
              <div>
                <a [routerLink]="" (click)="createNewTask('CreateTask')"
                  style="text-decoration: underline;float: left;color: #337ab7">Create New Task</a>
              </div>
            </td>
            <td>
            </td>
            <td>
            </td>
            <td colspan="2">
              <div>
                <span style="color: salmon">
                  {{addtionAssignedQty}}/{{ProductItem.value.orderedQty - ProductItem.value.totalAssignedQty}} units assigned
                </span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- ADd to current task -->
    <div class="ui-g-11" formArrayName="tasksArr" *ngIf="actionType === 'AddToCurrentTask'">
      <p-table [value]="tasksArr?.controls" id="tblCreateTask" name="tblCreateTask"
        styleClass="clsTableWithoutCss clsTable" [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width:17%;">Task Type</th>
            <th style="width:14%;">Task Status</th>
            <th style="width:15%;">Employee <span class="star">*</span></th>
            <th style="width:10%;">Assigned</th>
            <th style="width:10%;">Add Qty</th>
            <th style="width:20%;">Select Lot(s)</th>
            <th style="width:20px;"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-taskArrayItem let-i="rowIndex">
          <tr [formGroupName]="i">
            <td> {{ProductItem.controls.taskName.value}} </td>
            <td>
              <div *ngIf="taskArrayItem.value.taskId  ; else taskstatus_content">
                {{taskArrayItem.value.taskStatus}} </div>
              <ng-template #taskstatus_content>
                <div>
                  To Be Assigned
                </div>
              </ng-template>
            </td>
            <td>
              <div>

                <div *ngIf="taskArrayItem.value.taskId   ; else employee_content">
                  {{taskArrayItem.value.employeeName}}
                </div>
                <ng-template #employee_content>
                  <div>
                    <p-dropdown [filter]="true" (onChange)="onChange_Employee(taskArrayItem)" id="employee"
                      class="clsControl" tabindex="2" [options]="employees" placeholder="--Select--"
                      formControlName="employee">
                    </p-dropdown>
                  </div>
                  <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                    *ngIf="!taskArrayItem.controls['employee'].valid&&taskArrayItem.controls['employee'].dirty">
                    <span *ngIf="taskArrayItem.controls['employee'].hasError('duplicateemployee')">
                      same emplyee for task.
                    </span>
                    <span *ngIf="taskArrayItem.controls['employee'].errors['required']">
                      Please select employee.
                     </span> 
                  </div>
                </ng-template>
              </div>
            </td>
            <td>
              <div>
                <div *ngIf="taskArrayItem.value.taskId ; else assignedQty_content">
                  {{taskArrayItem.value.assignedQty}} {{taskArrayItem.value.pkgTypeName}}
                </div>
                <ng-template #assignedQty_content>
                  <div>
                    <span>N/A</span>
                  </div>
                </ng-template>

              </div>
            </td>
            <td>
              <div>

                <input pInputText name="addedQty" maxLength="10" pKeyFilter="num" tabindex="1" id="addedQty"
                  OnlyNumber="true" PositiveIntegers autocomplete="off" type="number" OnlyNumberWithoutZero="true"
                  (change)="addedQty_onChange(taskArrayItem, ProductItem.value.unassignedQty, i)" class="clsControl"
                  formControlName="addedQty" />
              </div>
              <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                *ngIf="!taskArrayItem.controls['addedQty'].valid&&taskArrayItem.controls['addedQty'].dirty">
                <span *ngIf="taskArrayItem.controls['addedQty'].errors['required']">
                  required
                </span>
                <span *ngIf="taskArrayItem.controls['addedQty'].hasError('assignedQtyExceeded')">
                  Weight exceeded.
                </span>
                <span *ngIf="taskArrayItem.controls['addedQty'].hasError('min')">
                 Qty should 1 or more.
                </span>
              </div>
            </td>
            <td>
              <div>
                <span *ngIf="ProductItem.value.skewkeyName === 'OIL'">
                  <span *ngIf="taskArrayItem.controls['addedQty'].value > 0  && (ProductItem.value.unassignedQty - addtionAssignedQty) >= 0  ; else taskSelectLotProductItem_content">
                    <a class="btn-link anchor" [class.clsLotSelected]="selectedPkgsArray.get(taskArrayItem.value.uniqueId)?.length > 0" [routerLink]=""
                      (click)="openPkgSelection(ProductItem, taskArrayItem, i)">
                      <span *ngIf="selectedPkgsArray.get(taskArrayItem.value.uniqueId)?.length <= 0">
                        Select Pkgs
                      </span>
                      <span *ngIf="selectedPkgsArray.get(taskArrayItem.value.uniqueId)?.length > 0">
                        View/Change Pkgs
                      </span>
                    </a>
                  </span>
                  <ng-template #taskSelectLotProductItem_content>
                    <div>
                      Select Pkgs
                    </div>
                  </ng-template>
                </span>
                <span *ngIf="ProductItem.value.skewkeyName === 'BUD' ">
                  <span *ngIf="taskArrayItem.controls['addedQty'].value > 0  && (ProductItem.value.unassignedQty - addtionAssignedQty) >= 0  ; else taskSelectLot1_content">
                    <a class="btn-link anchor"
                      [class.clsLotSelected]="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0"
                      [routerLink]="" (click)="openLotSelection(ProductItem, taskArrayItem, i)">
                      <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length <= 0">
                        Select Lots
                      </span>
                      <span *ngIf="selectedLotsArray.get(taskArrayItem.value.uniqueId)?.length > 0">
                        View/Change Lots
                      </span>
                    </a>
                  </span>
                  <ng-template #taskSelectLot1_content>
                    <div>
                      Select Lots
                    </div>
                  </ng-template>

                </span>

              </div>
            </td>
            <td> <span *ngIf="i>=1">
                <span
                  *ngIf="ProductItem.value.skewkeyName === 'BUD'  && taskArrayItem.value.taskStatus === 'ToBeAssigned'">
                  <a href="#" [routerLink]="" (click)="deleteItem(i, taskArrayItem)">
                    <span style="font-size: 1.4rem;" class="fa fa-trash">
                    </span>
                  </a>
                </span>
                <span
                  *ngIf="ProductItem.value.skewkeyName !== 'BUD'   && taskArrayItem.value.taskStatus === 'ToBeAssigned'">
                  <a href="#" [routerLink]="" (click)="deletePkgItem(i, taskArrayItem)">
                    <span style="font-size: 1.4rem;" class="fa fa-trash">
                    </span>
                  </a>
                </span>
              </span> </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td>
              <div>
                <a [routerLink]="" (click)="createNewTask('AddToCurrentTask')"
                  style="text-decoration: underline;float: left;color: #337ab7">Create New Task</a>
              </div>
            </td>
            <td>

            </td>
            <td>

            </td>
            <td>
            </td>
            <td colspan="2">
              <div>
                <span style="color: salmon">
                  {{addtionAssignedQty}}/{{ProductItem.value.unassignedQty}} units assigned
                </span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>



  <p-dialog header="Select Lots" [(visible)]="showLotSelectionModel" modal="modal" [resizable]="true"
    [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true">
    <form [formGroup]="questionForm" (ngSubmit)="submit(questionForm)" formSubmit>
      <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">
        <div class="ui-g">
          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>{{globalResource.genetics}}:</strong>
            </label>

            <label>
              {{ selLotBrandStrainRow?.GeneticsName }}
            </label>
          </div>
          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>{{assignTaskResources.lblRequiredWeight}}:</strong>
            </label>

            <label>
              {{ selLotBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
            </label>
          </div>
        </div>
        <div formArrayName="questions">
          <p-table [value]="questions?.controls" id="tblLotSelection">
            <ng-template pTemplate="header">
              <tr>
                <th style="width:150px">{{globalResource.strain}}</th>
                <th style="width:170px">{{globalResource.lotno}}</th>
                <th style="width:33.33333333%">{{assignTaskResources.lblAvailWeight}}</th>
                <th style="width:33.33333333%">{{assignTaskResources.lblSelectedWeight}}</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-question let-i="rowIndex">
              <tr [formGroupName]="i">
                <td style="width: 150px"> {{ brandStrainLots[i].StrainName  }}</td>
                <td style="width: 170px">
                  <label>{{ brandStrainLots[i].GrowerLotNo  }}</label>

                  <app-lot-comment [LotId]="question.value.LotNo" [LotCommentsCount]="brandStrainLots[i].LotNoteCount"
                    (CommentIconClicked)="commentIconClicked($event)"></app-lot-comment>

                  <app-lot-note-icon [LotId]="question.value.LotNo" (NoteIconClicked)="showLotNote($event)">
                  </app-lot-note-icon>
                </td>
                <td>
                  <ng-container *ngIf="taskId && taskId > 0">
                    {{ question.value.AvailWt  }} {{globalResource.listgramunit}}
                  </ng-container>

                  <ng-container *ngIf="!taskId">
                    {{ lotSyncWtArr.has(brandStrainLots[i].LotId) 
                        ? getLotSyncWt(brandStrainLots[i].LotId)
                        :  question.value.AvailWt }} {{globalResource.listgramunit}}
                  </ng-container>
                </td>
                <td>
                  <input type="number" (change)="lotWeightOnChange(question)" OnlyNumber="true" pInputText
                    pKeyFilter="pnum" autocomplete="off" formControlName="answer" id="answer" name="answer"
                    style="width:100%;" />
                  <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                    *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                    <span
                      *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                      {{assignTaskResources.errSelectValidWeight}}
                    </span>
                    <span *ngIf="question.controls['answer'].errors['required']" style="width:120px">
                      {{assignTaskResources.errWeightRequired}}
                    </span>
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
              <tr>
                <td [attr.colspan]="3">
                  {{ assignTaskResources.nolotpresent }} "{{ selLotBrandStrainRow?.StrainName }}".
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      <p-footer class="text-right">
        <button type="submit" pButton icon="fa-check" label="Confirm" id="btnLotSelectionConfirm"
          name="btnLotSelectionConfirm"></button>
        <button type="button" pButton icon="fa-close" (click)="showLotSelectionModel=false" label="Cancel"></button>
      </p-footer>
    </form>
  </p-dialog>

  <!--Select Packages For Order select package model-->
  <p-dialog header="Select Pkgs" [(visible)]="showPkgSelectionModel" modal="modal" [resizable]="true"
    [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true">
    <form [formGroup]="questionPkgForm" (ngSubmit)="submitPkg(questionPkgForm)" formSubmit>
      <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">

        <div class="ui-g">
          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>Genetics</strong>
            </label>

            <label>
              {{ selPkgBrandStrainRow?.GeneticsName }}
            </label>
          </div>
          <div class="ui-g-12 ui-md-6">
            <label>
              <strong>Required Weight</strong>
            </label>

            <label>
              {{ selPkgBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
            </label>
          </div>

        </div>
        <div formArrayName="pkgQuestions">
          <p-table [value]="pkgQuestions?.controls">
            <ng-template pTemplate="header">
              <tr>
                <th style="width:20%">Strain</th>
                <th style="width:20%">Oil Pkg Code</th>
                <th style="width:20%">TP Pkg. Type</th>
                <th style="width:20%">Avail. Oil Wt.</th>
                <th style="width:20%">Selected Weight</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-question let-i="rowIndex">
              <tr [formGroupName]="i">
                <td> {{ brandStrainPkgs[i].StrainName  }}</td>
                <td>
                  <label>{{ brandStrainPkgs[i].OilPkgCode  }}</label>
                </td>
                <td> {{ brandStrainPkgs[i].TPPkgTypeName  }}</td>
                <td>
                  <ng-container *ngIf="taskId && taskId > 0">
                    {{ question.value.AvailWt  }} {{globalResource.listgramunit}}
                  </ng-container>
                  <ng-container *ngIf="!taskId">
                    {{ lotSyncWtPkgArr.has(brandStrainPkgs[i].OilPkgId) 
                        ? getLotSyncPkgWt(brandStrainPkgs[i].OilPkgId)
                        :  question.value.AvailWt }} {{globalResource.listgramunit}}
                  </ng-container>
                </td>

                <td>
                  <input pKeyFilter="pnum" type="number" OnlyNumber="true" pInputText autocomplete="off"
                    formControlName="answer" id="answer" name="answer" (change)="pkgWeightOnChange(question)"
                    style="width:100%;" />
                  <div class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                    *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                    <span
                      *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                      Select Valid Weight
                    </span>
                    <span *ngIf="question.controls['answer'].errors['required']">
                      Required
                    </span>
                    <span *ngIf="question.controls['answer'].hasError('oilpkgmaxwtexceeded')">
                      max lot wt exceeded
                    </span>
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
              <tr>
                <td [attr.colspan]="4">
                  Sorry, No package is present against "{{ selPkgBrandStrainRow?.StrainName }}".
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      <p-footer class="text-right">

        <button type="submit" pButton icon="fa-check" label="Confirm"></button>
        <!-- [disabled]="questionForm.invalid" -->
        <button type="button" pButton icon="fa-close" (click)="showPkgSelectionModel=false" label="Cancel"></button>
      </p-footer>
    </form>
  </p-dialog>
</form>
<app-lot-note [Lot]="lotInfo" *ngIf="lotInfo?.showLotNoteModal" (NoteSaved)="onNoteSave($event)"></app-lot-note>

<app-popup-lot-comment [Lot]="lotInfo" *ngIf="lotInfo?.showLotCommentModal" (CommentSaved)="OnCommentSaved($event)">
</app-popup-lot-comment>

<p-growl [(value)]="msgs" life='5000'></p-growl>