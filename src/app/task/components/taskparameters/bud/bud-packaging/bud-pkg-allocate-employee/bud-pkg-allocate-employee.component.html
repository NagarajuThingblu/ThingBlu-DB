<form [formGroup]="BudPkgForm" >
<!-- <p-dialog header="Allocate Employees" [(visible)]="AllocateEmpData.showDialog" modal="modal" [resizable]="true"
  (onHide)="onDialogHide()" [responsive]="true" [width]="1000" [minWidth]="300"> -->
  <div class="ui-g">
    <!-- <div class="ui-g-12">
        <a class="pull-right anchor" href="javascript:void(0)"><span>< Back</span></a>
    </div> -->
    <div class="ui-g-12 ui-md-12 ui-g-nopad">
          <!-- Assign To All Dropdown -->
          <div class="ui-g-12 ui-md-6 ">
              <div class="paddingRL">
                <label>
                  {{ assignTaskResources.lblAssignToAll }}
                </label>
                <div>
                  <p-dropdown
                    [filter] ="true"
                    [options]="employees"
                    (onChange)="assignToAllChange()"
                    formControlName="assignToAll"
                    defaultLabel="-- Select --"
                    class="clsControl"
                    id="allocateEmp"
                    name="allocateEmp"
                  ></p-dropdown>
                </div>
              </div>
            </div>
    </div>

    <div class="ui-g-12 ui-md-12">
        <app-section-header headerLabel="Order Items"></app-section-header>

        <div class="ui-g" formArrayName="allocateEmpArr">
            <div class="ui-g-12 ui-md-12">
                <p-table #dtAllocateEmp
                [value]="allocateEmpArr?.controls"
                styleClass="clsTableWithoutCss"
                responsive="true"
              >
              <ng-template pTemplate="header" class="header-tab">
                <tr>                                   
                  <th style="width: 20%;"> {{globalResource.strain}} </th>
                  <th  *ngIf="taskCategory === 'GROWING'" style="width: 20%;">SkewKeyName</th>
                  <th style="width: 12%;"> {{globalResource.pkgsize}} </th>
                  <th *ngIf="taskCategory != 'GROWING'" style="width: 8%;"> {{globalResource.total}} </th>
                  <!-- <th *ngIf="taskCategory != 'GROWING'" style="width: 8%;"> Total Weight</th> -->
                  <th *ngIf="taskCategory != 'GROWING'" style="width: 15%;"> {{globalResource.assignqty}} <span class="star">*</span> </th>
                  <th *ngIf="taskCategory === 'GROWING'" style="width: 15%;"> Assigned Wt(lb) <span class="star">*</span> </th>
                  <th *ngIf="taskCategory != 'GROWING'" style="width: 15%;"> {{globalResource.lot + '(s)'}} </th>
                  <th *ngIf="taskCategory === 'GROWING'" style="width: 15%;"> Bin(s) </th>
                  <th style="width: 30%;"> {{globalResource.employee}} <span class="star">*</span> </th>
                  <th style="width: 5%;"> </th>
                  <th style="width: 5%;"> </th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-rowData let-i="rowIndex" >
                <tr [formGroupName]="i" class="pkgInfo">
                  <td  
                    title="{{rowData.value.toolTip}}" 
                    tooltipPosition="top" >
                    <span class="ui-column-title">{{globalResource.strain}}</span>
                    {{rowData.value.strainName}}
                  </td>
                  <td *ngIf="taskCategory === 'GROWING'">
                    <span class="ui-column-title">SkewName</span>
                    {{rowData.value.SkewKeyName}}
                  </td>
                  <td>
                    <span class="ui-column-title">{{globalResource.pkgsize}}</span>
                    <a *ngIf="taskCategory != 'GROWING'" [routerLink]="" 
                      (click)="getSelectedProduct(rowData)" class="btn-link anchor">
                      {{rowData.value.pkgSize}} {{globalResource.listgramunits}}
                    </a> 
                    <a *ngIf="taskCategory === 'GROWING'" [routerLink]="" 
                      (click)="getSelectedProduct(rowData)" class="btn-link anchor">
                      {{rowData.value.pkgSize}}(lb)
                    </a>                    
                  </td>
                  <td *ngIf="taskCategory != 'GROWING'">
                      <span  class="ui-column-title">{{globalResource.total}}</span>
                      {{rowData.value.requiredQty}}
                    </td>
                    <!-- <td *ngIf="taskCategory === 'GROWING'">
                      <span  class="ui-column-title">Total Weight</span>
                      {{rowData.value.totalQty}}
                    </td> -->
                    <td>
                        <span class="ui-column-title">{{globalResource.assignqty}}</span>
                        
                        <input pInputText 
                        *ngIf="taskCategory != 'GROWING'" 
                          autocomplete="off"
                          (change)="assignQtyChange(rowData, i)"
                          maxlength="6"
                          name="assignQty"
                          type="number"
                          pKeyFilter="pint"
                          formControlName="assignQty"
                          class="clsControl"
                         />
                         <input pInputText
                         *ngIf="taskCategory === 'GROWING'" 
                          autocomplete="off"
                          (change)="assignQtyChange(rowData, i)"
                          maxlength="6"
                          name="TotalWt"
                          type="number"
                          pKeyFilter="pint"
                          formControlName="TotalWt"
                          class="clsControl"
                         />
                         <div  
                              class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                              *ngIf="!rowData.controls['assignQty'].valid&&rowData.controls['assignQty'].dirty">
                                <span *ngIf="rowData.controls['assignQty'].hasError('greaterQty')">
                                   <!-- Sum must equal Total(-{{rowData.controls['assignQty'].errors['greaterQty'].totalAssigedQty - rowData.controls['assignQty'].errors['greaterQty'].totalRequiredQty }}) -->
                                  <span *ngIf="!rowData.controls['assignQty'].errors['greaterQty']?.isSplitted">
                                    Assign Qty cannot be more than the Total
                                  </span>
                                    <span *ngIf="rowData.controls['assignQty'].errors['greaterQty']?.isSplitted">
                                      Assign Qty's cannot be more than the Total when task is split
                                    </span>
                                  </span>
                                 <!-- comment max qty validation -->
                               <span *ngIf="rowData.controls['assignQty'].errors['max']">
                                    Max value is {{ rowData.controls['assignQty'].errors['max'].max }}
                                </span> 
                          </div>
                          
                    </td>
                  <td>
                      <span *ngIf="taskCategory != 'GROWING'" class="ui-column-title">{{globalResource.lot + '(s)'}}</span>
                      <span *ngIf="taskCategory === 'GROWING'" class="ui-column-title">Bin(s)</span>
                      <div   *ngIf="taskCategory != 'GROWING'">
                        <span  *ngIf="rowData.value.lotCount > 0&&rowData.value.assignQty > 0" >
                          <a 
                            class="btn-link anchor"
                            [class.clsLotSelected]="selectedLotsArray.get(rowData.value.uniqueId)?.length > 0"
                            [routerLink]="" 
                            (click)="openLotSelection(rowData, i)"
                          > 
                            <span *ngIf="selectedLotsArray.get(rowData.value.uniqueId)?.length <= 0">
                              {{assignTaskResources.lnkSelectLots}}
                            </span>
                            <span style="color:forestgreen" *ngIf="selectedLotsArray.get(rowData.value.uniqueId)?.length > 0">
                              {{assignTaskResources.viewChangeLots}}
                            </span>
                          </a>
                        </span>
                        <span  *ngIf="rowData.value.assignQty == 0" >
                           {{assignTaskResources.lnkSelectLots}}
                        </span>
                        <span class="star"  *ngIf="!rowData.value.lotCount" >
                          {{assignTaskResources.lblNoLotPresent}}
                        </span>
                      </div>
                      <div   *ngIf="taskCategory === 'GROWING'">
                        <span >
                          <a 
                            class="btn-link anchor"
                            [routerLink]="" 
                            (click)="openLotSelection(rowData,i)"
                          > 
                          <span *ngIf="selectedLotsArray.get(rowData.value.uniqueId)?.length <= 0">
                            {{assignTaskResources.lnkSelectBins}}
                          </span>
                          <span style="color:forestgreen" *ngIf="selectedLotsArray.get(rowData.value.uniqueId)?.length > 0">
                            {{assignTaskResources.viewChangeBins}}
                          </span>
                          </a>
                        </span>
                        <span  *ngIf="rowData.value.TotalWt == 0" >
                           {{assignTaskResources.lnkSelectBins}}
                        </span>
                        <!-- <span class="star"  *ngIf="!rowData.value.LotCount" >
                         No Bin available
                        </span> -->
                      </div>

                      <div
                        class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                        *ngIf="rowData.value.lotCount > 0 && selectedLotsArray.get(rowData.value.uniqueId)?.length <= 0 && rowData?.errors?.INVALIDROW">                       
                          <span>
                           <!--Duplicate tasks for same employee.--> 
                           {{assignTaskResources.lotsnotassigned}}
                          </span>
                      </div>
                      <!-- <a class="anchor" href="javascript:void(0)"><span>Select Lots</span></a> -->
                    </td>
                  <td class="text-center"> 
                      <span class="ui-column-title">{{globalResource.employee}}</span>
                      <div>
                        <!-- <p-dropdown
                          [filter] ="true"
                          [options]="employees"
                          [readonly]="rowData.value.assignQty == 0"
                          [styleClass]="rowData.value.assignQty == 0 ? 'clsBackgroundGrey' : ''"
                          (onChange)="rowEmpChange(i)"
                          formControlName="employee"
                          defaultLabel="-- Select --"
                          class="clsControl"
                          id="employee"
                          name="employee"
                        ></p-dropdown> -->

                          <div class="input-container">
                            <input pInputText
                           style="cursor: pointer;"
                            autocomplete="off"
                            formControlName="employee"
                            id="employee"
                            name="employee"
                            class="clsControl"
                            placeholder="- -Select- -"
                           (click)="showEmps(i,$event)"
                          />
                          <span  style="width:24px;text-align: center; cursor: pointer;" (click)="showEmps(i,$event)">
                            <i  style="cursor: pointer;" class="fa fa-caret-down" ria-hidden="true"  (click)="showEmps(i,$event)"></i>
                          </span>
                          <!-- <span style="width:24px;text-align: center; cursor: pointer;"  *ngIf="showUpArrow[i].label" (click)="showEmps(i,$event)">
                            <i style="cursor: pointer;" class="fa fa-caret-up" ria-hidden="true"  (click)="showEmps(i,$event)"></i>
                          </span> -->
                        </div>
                        <p-tree [value]="AllocateEmpData.files" [ngClass]="visibility[i].label !== true?'myskillsdropdown':'showmyskillsdropdown'" styleClass="clsRoleAccessTree" selectionMode="single"  [(selection)]="selectedSkillItems"
                        [propagateSelectionUp]="false" (onNodeSelect)="OnSelectingEmployees(i,$event)" (onNodeUnselect) = "OnUnSelectNode($event)" [propagateSelectionDown]="true"></p-tree>
                       
                      </div>
                      <!-- <div
                        class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                        *ngIf="!rowData.controls['employee'].valid&&rowData.controls['employee'].dirty">
                        <span *ngIf="rowData.controls['employee'].errors['required']">
                          {{globalResource.employeerequired}}
                          </span>
                          <span *ngIf="rowData.controls['employee'].hasError('duplicateProductEmployee')">
                           {{assignTaskResources.errSameEmpForTask}}
                          </span>
                      </div> -->
                      
                  </td>  
                  <td class="text-center"> 
                      <ng-container *ngIf="rowData.value.lotCount">
                        <a 
                          pTooltip="{{assignTaskResources.tpSplitTask}}"
                          tooltipPosition="left"
                          [routerLink]="" 
                          (click)="splitTask(rowData, i)"
                          style="font-size: 24px"
                        > <span class="fa fa-share-alt"></span>
                        </a>
                        <!-- <button pButton 
                          type="button" 
                          (click)="splitTask(rowData, i)" 
                          label="Split Task">
                        </button> -->
                      </ng-container>
                      <!-- <ng-container *ngIf="rowData.value.assignQty <= 1||!rowData.value.lotCount">
                         <button pButton 
                          type="button"
                          class="ui-button-rounded disableGrayButton"
                          label="Split Task">
                        </button> 
                        <span style="font-size: 20px" pTooltip="{{assignTaskResources.tpSplitTask}}"
                        tooltipPosition="left" class="fa fa-clone mt-1"></span>
                      </ng-container> -->
                  </td>  
                  <td> 
                      <!-- <button  *ngIf="rowData.value.parentUniqueId" pButton type="button" (click)="undoTask(rowData, i)" label="Undo"  class="ui-button-danger"></button> -->
                      <ng-container *ngIf="rowData.value.parentUniqueId">
                        <a style="font-size: 24px"
                          pTooltip="{{assignTaskResources.tpUndoTask}}"
                          tooltipPosition="left"
                          [routerLink]="" 
                          (click)="undoTask(rowData, i)"
                        > <span class="fa fa-undo star"></span>
                        </a>
                      </ng-container>
                  </td>              
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="0">
                    {{ globalResource.norecordsfound }}
                  </td>
                </tr>
              </ng-template>
            </p-table>
            </div>
        </div>

    </div>

    <!-- <div class="ui-g-12 ui-md-12 marginTop-15" >
        <button pButton type="submit"  label="Create Task" ></button>
        <a class="anchor" (click)="resetForm()" href="javascript:void(0)"><span>Clear</span></a>
    </div> -->
    
  </div>


  <p-dialog [header]="taskCategory === 'GROWING'?'Select Bins':'Select Lots'"
  [(visible)]="showLotSelectionModel"
  modal="modal"
  [resizable]="true"
  [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true" >

  <form [formGroup]="questionForm" (ngSubmit)="submit(questionForm)" formSubmit >
        
  <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">

    <div class="ui-g">
            <div class="ui-g-12 ui-md-6">
              <label>
                  <strong>{{globalResource.genetics}}:</strong>
                </label>

                <label>
                  {{ selLotBrandStrainRow?.GeneticsName }}
                </label>
            </div>

              <div class="ui-g-12 ui-md-6">
                  <label>
                    <strong>{{assignTaskResources.lblRequiredWeight}}:</strong>
                  </label>

                  <label *ngIf="taskCategory != 'GROWING'">
                    {{ selLotBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
                  </label>
                  <label *ngIf="taskCategory === 'GROWING'">
                    {{ selLotBrandStrainRow?.combinationTotalAssignedWt }} (lb)
                  </label>
                </div>

      </div>
      <div formArrayName="questions">
      <p-table [value]="questions?.controls" id="tblLotSelection">
          <ng-template pTemplate="header">
              <tr>
                  <th style="width:150px">{{globalResource.strain}}</th>
                  <th style="width:170px" *ngIf="taskCategory != 'GROWING'">{{globalResource.lotno}}</th>
                  <th style="width:170px" *ngIf="taskCategory === 'GROWING'">Bin No</th>
                  <th style="width:33.33333333%">{{assignTaskResources.lblAvailWeight}}</th>
                  <th style="width:33.33333333%">{{assignTaskResources.lblSelectedWeight}}</th>
              </tr>
          </ng-template>
          <ng-template pTemplate="body" let-question let-i="rowIndex" >
              <tr [formGroupName]="i">
                  <td style="width: 150px"> {{ brandStrainLots[i].StrainName  }}</td>
                  <td style="width: 170px">
                      <!-- <p-checkbox
                        label="{{ brandStrainLots[i].GrowerLotNo  }}"
                        formControlName="question"
                        (ngModelChange)="changeValidator($event, i)"
                        binary="true"
                      ></p-checkbox> -->
                      <label *ngIf="taskCategory != 'GROWING'">{{ brandStrainLots[i].GrowerLotNo  }}</label>
                      <label *ngIf="taskCategory === 'GROWING'">{{ brandStrainLots[i].LabelName  }}</label>

                      <app-lot-comment
                      *ngIf="taskCategory != 'GROWING'"
                          [LotId]="question.value.LotNo"
                          [LotCommentsCount]="brandStrainLots[i].LotNoteCount"
                          (CommentIconClicked)="commentIconClicked($event)"
                      ></app-lot-comment>
                      <!-- <app-lot-comment
                      *ngIf="taskCategory === 'GROWING'"
                          [LotId]="question.value.LotNo"
                          [LotCommentsCount]="brandStrainLots[i].LotNoteCount"
                          (CommentIconClicked)="commentIconClicked($event)"
                      ></app-lot-comment> -->

                      <app-lot-note-icon
                      *ngIf="taskCategory != 'GROWING'"
                        [LotId]="question.value.LotNo"                                
                        (NoteIconClicked)="showLotNote($event)"
                      ></app-lot-note-icon>
                                              
                  </td>

                  <td>
                    <ng-container *ngIf="taskId && taskId > 0&&taskCategory != 'GROWING'">
                      {{ question.value.AvailWt  }} {{globalResource.listgramunit}}
                    </ng-container>
                    <ng-container *ngIf="taskId && taskId > 0&&taskCategory === 'GROWING'">
                      {{ question.value.AvailWt  }} (lb)
                    </ng-container>
                    <!-- <ng-container *ngIf="taskId && taskId > 0 &&taskCategory === 'GROWING'">
                      {{brandStrainLots[i].AvilableWeight  }} {{globalResource.listgramunit}}
                    </ng-container> -->
                    
                    <ng-container *ngIf="!taskId&&taskCategory != 'GROWING'">
                      <!-- {{ lotSyncWtArr.get(parseInt(brandStrainLots[i].LotId)) || 0 }} {{globalResource.listgramunit}} -->
                      {{ lotSyncWtArr.has(brandStrainLots[i].LotId) 
                          ? getLotSyncWt(brandStrainLots[i].LotId)
                          :  question.value.AvailWt }} {{globalResource.listgramunit}}
                    </ng-container>
                    <ng-container *ngIf="!taskId&&taskCategory === 'GROWING'">
                      <!-- {{ lotSyncWtArr.get(parseInt(brandStrainLots[i].LotId)) || 0 }} {{globalResource.listgramunit}} -->
                      {{ lotSyncWtArr.has(brandStrainLots[i].InputBinId) 
                          ? getLotSyncWt(brandStrainLots[i].InputBinId)
                          :  question.value.AvailWt }} (lb)
                    </ng-container>
                  </td>
                  <td>
                    <input
                     
                      type="number"
                      (change)="lotWeightOnChange(question)"
                      OnlyNumber="true"
                      pInputText
                      pKeyFilter="pnum"
                      autocomplete="off"
                      formControlName="answer"
                      id="answer"
                      name="answer"
                      style="width:100%;"
                  />                          
                  <div
                      class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                      *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                        <span *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                          {{assignTaskResources.errSelectValidWeight}}
                        </span>  
                        <span *ngIf="question.controls['answer'].errors['required']" style="width:120px">
                          {{assignTaskResources.errWeightRequired}}
                        </span>

                  </div>
                </td>
              </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage" let-columns>
            <tr>
                <td *ngIf="taskCategory != 'GROWING'" [attr.colspan]="3">
                  {{ assignTaskResources.nolotpresent }} "{{ selLotBrandStrainRow?.StrainName }}".
                </td>
                <td *ngIf="taskCategory === 'GROWING'" [attr.colspan]="3">
                  {{ assignTaskResources.nobinpresent }} "{{ selLotBrandStrainRow?.StrainName }}".
                </td>
            </tr>
          </ng-template>
      </p-table>
      </div>
    </div>
    <p-footer class="text-right">

      <button type="submit"  pButton icon="fa-check"  label="Confirm" id="btnLotSelectionConfirm" name="btnLotSelectionConfirm" ></button>
      
      <button type="button" pButton icon="fa-close" (click)="showLotSelectionModel=false" label="Cancel"></button>
  </p-footer>
</form>
</p-dialog>
<!-- </p-dialog> -->




<!-- p dialog product -->

<p-dialog header="Product Information"
[(visible)]="showProductInfoModel"
  modal="modal"
  [resizable]="true"
  [responsive]="true" [width]="400" [minWidth]="300" [blockScroll]="true">
  <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid">

    <div class="ui-g" >
            <div class="ui-g-12 ui-md-6" *ngIf="taskCategory != 'GROWING'">
                 <label>
                  <strong>{{globalResource.brand}}</strong>
                 </label>
                <br>
                <label>
                   {{productTypeData?.brandName}}
                </label>
            </div>
            <div class="ui-g-12 ui-md-6" *ngIf="taskCategory != 'GROWING'">                
                  <label>
                    <strong>{{globalResource.subbrand}}</strong>
                  </label>
                  <br>
                  <label>
                    {{productTypeData?.subBrandName}}
                  </label>                   
            </div>
            <div class="ui-g-12 ui-md-6">                
                <label>
                  <strong>{{globalResource.pkgtype}}</strong>
                </label>
                <br>
                <label>
                   {{productTypeData?.pkgTypeName}}
                </label>                   
        </div>
        <div class="ui-g-12 ui-md-6">                
              <label>
                 <strong>{{globalResource.pkgsize}}</strong>
              </label>
            <br>
              <label *ngIf="taskCategory != 'GROWING'">
                 {{productTypeData?.pkgSize}}  {{globalResource.listgramunit}}
              </label>  
              <label *ngIf="taskCategory === 'GROWING'">
                {{productTypeData?.pkgSize}}  (lb)
             </label>                   
    </div>
    <div class="ui-g-12 ui-md-6">                
          <label>
            <strong>{{globalResource.strain}}</strong>
          </label>
        <br>
          <label>
             {{productTypeData?.strainName}}
          </label>                   
</div>
<div class="ui-g-12 ui-md-6" *ngIf="taskCategory === 'GROWING'">                
  <label>
    <strong>SkewName</strong>
  </label>
<br>
  <label>
     {{productTypeData?.SkewKeyName}}
  </label>                   
</div>
    </div>
    </div>

</p-dialog>

<!--<button type="text" (click)="showProductInfoModel" pButton icon="fa-external-link-square" label="Show"></button>-->
<app-lot-note [Lot]="lotInfo" *ngIf="lotInfo?.showLotNoteModal" (NoteSaved)="onNoteSave($event)" ></app-lot-note> 

<app-popup-lot-comment [Lot]="lotInfo" *ngIf="lotInfo?.showLotCommentModal" (CommentSaved)="OnCommentSaved($event)">
</app-popup-lot-comment>

<p-growl [(value)]="msgs" life='5000' ></p-growl>
</form>