<form [formGroup]="BudPkgForm" >
<!-- <p-dialog header="Allocate Employees" [(visible)]="AllocateEmpData.showDialog" modal="modal" [resizable]="true"
  (onHide)="onDialogHide()" [responsive]="true" [width]="1000" [minWidth]="300"> -->
  <div class="ui-g">
    <!-- <div class="ui-g-12">
        <a class="pull-right anchor" href="javascript:void(0)"><span>< Back</span></a>
    </div> -->
    <div class="ui-g-12 ui-md-12 ui-g-nopad">
          <!-- Assign To All Dropdown -->
          <div class="ui-g-12 ui-md-6 ">
              <div class="paddingRL">
                <label>
                  {{ assignTaskResources.lblAssignToAll }}
                </label>
                <div>
                  <p-dropdown
                    [filter] ="true"
                    [options]="employees"
                    (onChange)="assignToAllChange()"
                    formControlName="assignToAll"
                    defaultLabel="-- Select --"
                    class="clsControl"
                    id="allocateEmp"
                    name="allocateEmp"
                  ></p-dropdown>
                </div>
              </div>
            </div>
    </div>

    <div class="ui-g-12 ui-md-12">
        <app-section-header headerLabel="Order Items"></app-section-header>

        <div class="ui-g" formArrayName="allocateEmpArr">
            <div class="ui-g-12 ui-md-12">
                <p-table #dtAllocateEmp
                [value]="allocateEmpArr?.controls"
                styleClass="clsTableWithoutCss"
                responsive="true"
              >
              <ng-template pTemplate="header" class="header-tab">
                <tr>                                   
                  <th style="width: 20%;"> {{globalResource.strain}} </th>
                  <th style="width: 12%;"> {{globalResource.pkgsize}} </th>
                  <th style="width: 8%;"> {{globalResource.total}} </th>
                  <th style="width: 15%;"> {{globalResource.assignqty}} <span class="star">*</span> </th>
                  <th style="width: 15%;"> {{globalResource.lot + '(s)'}} </th>
                  <th style="width: 20%;"> {{globalResource.employee}} <span class="star">*</span> </th>
                  <th style="width: 5%;"> </th>
                  <th style="width: 5%;"> </th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-rowData let-i="rowIndex" >
                <tr [formGroupName]="i" class="pkgInfo">
                  <td  
                    title="{{rowData.value.toolTip}}" 
                    tooltipPosition="top" >
                    <span class="ui-column-title">{{globalResource.strain}}</span>
                    {{rowData.value.strainName}}
                  </td>
                  <td>
                    <span class="ui-column-title">{{globalResource.pkgsize}}</span>
                    <a [routerLink]="" 
                      (click)="getSelectedProduct(rowData)" class="btn-link anchor">
                      {{rowData.value.pkgSize}} {{globalResource.listgramunits}}
                    </a>                    
                  </td>
                  <td>
                      <span class="ui-column-title">{{globalResource.total}}</span>
                      {{rowData.value.requiredQty}}
                    </td>
                    <td>
                        <span class="ui-column-title">{{globalResource.assignqty}}</span>
                        
                        <input pInputText 
                          autocomplete="off"
                          (change)="assignQtyChange(rowData, i)"
                          maxlength="6"
                          name="assignQty"
                          type="number"
                          pKeyFilter="pint"
                          formControlName="assignQty"
                          class="clsControl"
                         />
                         <div
                              class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                              *ngIf="!rowData.controls['assignQty'].valid&&rowData.controls['assignQty'].dirty">
                                <span *ngIf="rowData.controls['assignQty'].hasError('greaterQty')">
                                   <!-- Sum must equal Total(-{{rowData.controls['assignQty'].errors['greaterQty'].totalAssigedQty - rowData.controls['assignQty'].errors['greaterQty'].totalRequiredQty }}) -->
                                  <span *ngIf="!rowData.controls['assignQty'].errors['greaterQty']?.isSplitted">
                                    Assign Qty cannot be more than the Total
                                  </span>
                                    <span *ngIf="rowData.controls['assignQty'].errors['greaterQty']?.isSplitted">
                                      Assign Qty's cannot be more than the Total when task is split
                                    </span>
                                  </span>
                                 <!-- comment max qty validation -->
                               <span *ngIf="rowData.controls['assignQty'].errors['max']">
                                    Max value is {{ rowData.controls['assignQty'].errors['max'].max }}
                                </span> 
                          </div>
                    </td>
                  <td>
                      <span class="ui-column-title">{{globalResource.lot + '(s)'}}</span>

                      <div>
                        <span  *ngIf="rowData.value.lotCount > 0&&rowData.value.assignQty > 0" >
                          <a 
                            class="btn-link anchor"
                            [class.clsLotSelected]="selectedLotsArray.get(rowData.value.uniqueId)?.length > 0"
                            [routerLink]="" 
                            (click)="openLotSelection(rowData, i)"
                          > 
                            <span *ngIf="selectedLotsArray.get(rowData.value.uniqueId)?.length <= 0">
                              {{assignTaskResources.lnkSelectLots}}
                            </span>
                            <span *ngIf="selectedLotsArray.get(rowData.value.uniqueId)?.length > 0">
                              {{assignTaskResources.viewChangeLots}}
                            </span>
                          </a>
                        </span>
                        <span  *ngIf="rowData.value.assignQty == 0" >
                           {{assignTaskResources.lnkSelectLots}}
                        </span>
                        <span class="star"  *ngIf="!rowData.value.lotCount" >
                          {{assignTaskResources.lblNoLotPresent}}
                        </span>
                      </div>

                      <div
                        class="ui-message ui-messages-error ui-corner-all" appErrorTooltip
                        *ngIf="rowData.value.lotCount > 0 && selectedLotsArray.get(rowData.value.uniqueId)?.length <= 0 && rowData?.errors?.INVALIDROW">                       
                          <span>
                           <!--Duplicate tasks for same employee.--> 
                           {{assignTaskResources.lotsnotassigned}}
                          </span>
                      </div>
                      <!-- <a class="anchor" href="javascript:void(0)"><span>Select Lots</span></a> -->
                    </td>
                  <td class="text-center"> 
                      <span class="ui-column-title">{{globalResource.employee}}</span>
                      <div>
                        <p-dropdown
                          [filter] ="true"
                          [options]="employees"
                          [readonly]="rowData.value.assignQty == 0"
                          [styleClass]="rowData.value.assignQty == 0 ? 'clsBackgroundGrey' : ''"
                          (onChange)="rowEmpChange(i)"
                          formControlName="employee"
                          defaultLabel="-- Select --"
                          class="clsControl"
                          id="employee"
                          name="employee"
                        ></p-dropdown>
                      </div>
                      <div
                        class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                        *ngIf="!rowData.controls['employee'].valid&&rowData.controls['employee'].dirty">
                        <span *ngIf="rowData.controls['employee'].errors['required']">
                          {{globalResource.employeerequired}}
                          </span>
                          <span *ngIf="rowData.controls['employee'].hasError('duplicateProductEmployee')">
                           {{assignTaskResources.errSameEmpForTask}}
                          </span>
                      </div>
                      
                  </td>  
                  <td class="text-center"> 
                      <ng-container *ngIf="rowData.value.lotCount">
                        <a 
                          pTooltip="{{assignTaskResources.tpSplitTask}}"
                          tooltipPosition="left"
                          [routerLink]="" 
                          (click)="splitTask(rowData, i)"
                          style="font-size: 24px"
                        > <span class="fa fa-share-alt"></span>
                        </a>
                        <!-- <button pButton 
                          type="button" 
                          (click)="splitTask(rowData, i)" 
                          label="Split Task">
                        </button> -->
                      </ng-container>
                      <!-- <ng-container *ngIf="rowData.value.assignQty <= 1||!rowData.value.lotCount">
                         <button pButton 
                          type="button"
                          class="ui-button-rounded disableGrayButton"
                          label="Split Task">
                        </button> 
                        <span style="font-size: 20px" pTooltip="{{assignTaskResources.tpSplitTask}}"
                        tooltipPosition="left" class="fa fa-clone mt-1"></span>
                      </ng-container> -->
                  </td>  
                  <td> 
                      <!-- <button  *ngIf="rowData.value.parentUniqueId" pButton type="button" (click)="undoTask(rowData, i)" label="Undo"  class="ui-button-danger"></button> -->
                      <ng-container *ngIf="rowData.value.parentUniqueId">
                        <a style="font-size: 24px"
                          pTooltip="{{assignTaskResources.tpUndoTask}}"
                          tooltipPosition="left"
                          [routerLink]="" 
                          (click)="undoTask(rowData, i)"
                        > <span class="fa fa-undo star"></span>
                        </a>
                      </ng-container>
                  </td>              
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="0">
                    {{ globalResource.norecordsfound }}
                  </td>
                </tr>
              </ng-template>
            </p-table>
            </div>
        </div>

    </div>

    <!-- <div class="ui-g-12 ui-md-12 marginTop-15" >
        <button pButton type="submit"  label="Create Task" ></button>
        <a class="anchor" (click)="resetForm()" href="javascript:void(0)"><span>Clear</span></a>
    </div> -->
    
  </div>


  <p-dialog header="Select Lots"
  [(visible)]="showLotSelectionModel"
  modal="modal"
  [resizable]="true"
  [responsive]="true" [width]="600" [minWidth]="300" [blockScroll]="true" >

  <form [formGroup]="questionForm" (ngSubmit)="submit(questionForm)" formSubmit >
        
  <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid" style="margin: 10px 0px">

    <div class="ui-g">
            <div class="ui-g-12 ui-md-6">
              <label>
                  <strong>{{globalResource.genetics}}:</strong>
                </label>

                <label>
                  {{ selLotBrandStrainRow?.GeneticsName }}
                </label>
            </div>

              <div class="ui-g-12 ui-md-6">
                  <label>
                    <strong>{{assignTaskResources.lblRequiredWeight}}:</strong>
                  </label>

                  <label>
                    {{ selLotBrandStrainRow?.combinationTotalAssignedWt }} {{globalResource.measure}}
                  </label>
                </div>

      </div>
      <div formArrayName="questions">
      <p-table [value]="questions?.controls" id="tblLotSelection">
          <ng-template pTemplate="header">
              <tr>
                  <th style="width:150px">{{globalResource.strain}}</th>
                  <th style="width:170px">{{globalResource.lotno}}</th>
                  <th style="width:33.33333333%">{{assignTaskResources.lblAvailWeight}}</th>
                  <th style="width:33.33333333%">{{assignTaskResources.lblSelectedWeight}}</th>
              </tr>
          </ng-template>
          <ng-template pTemplate="body" let-question let-i="rowIndex" >
              <tr [formGroupName]="i">
                  <td style="width: 150px"> {{ brandStrainLots[i].StrainName  }}</td>
                  <td style="width: 170px">
                      <!-- <p-checkbox
                        label="{{ brandStrainLots[i].GrowerLotNo  }}"
                        formControlName="question"
                        (ngModelChange)="changeValidator($event, i)"
                        binary="true"
                      ></p-checkbox> -->
                      <label>{{ brandStrainLots[i].GrowerLotNo  }}</label>

                      <app-lot-comment
                          [LotId]="question.value.LotNo"
                          [LotCommentsCount]="brandStrainLots[i].LotNoteCount"
                          (CommentIconClicked)="commentIconClicked($event)"
                      ></app-lot-comment>

                      <app-lot-note-icon
                        [LotId]="question.value.LotNo"                                
                        (NoteIconClicked)="showLotNote($event)"
                      ></app-lot-note-icon>
                                              
                  </td>

                  <td>
                    <ng-container *ngIf="taskId && taskId > 0">
                      {{ question.value.AvailWt  }} {{globalResource.listgramunit}}
                    </ng-container>
                    
                    <ng-container *ngIf="!taskId">
                      <!-- {{ lotSyncWtArr.get(parseInt(brandStrainLots[i].LotId)) || 0 }} {{globalResource.listgramunit}} -->
                      {{ lotSyncWtArr.has(brandStrainLots[i].LotId) 
                          ? getLotSyncWt(brandStrainLots[i].LotId)
                          :  question.value.AvailWt }} {{globalResource.listgramunit}}
                    </ng-container>
                  </td>
                  <td>
                    <input
                     
                      type="number"
                      (change)="lotWeightOnChange(question)"
                      OnlyNumber="true"
                      pInputText
                      pKeyFilter="pnum"
                      autocomplete="off"
                      formControlName="answer"
                      id="answer"
                      name="answer"
                      style="width:100%;"
                  />                          
                  <div
                      class="ui-message ui-messages-error ui-corner-all" appErrorTooltip tooltipPosition="left"
                      *ngIf="!question.controls['answer'].valid&&question.controls['answer'].dirty">
                        <span *ngIf="question.controls['answer'].errors['max'] || question.controls['answer'].errors['min']">
                          {{assignTaskResources.errSelectValidWeight}}
                        </span>  
                        <span *ngIf="question.controls['answer'].errors['required']" style="width:120px">
                          {{assignTaskResources.errWeightRequired}}
                        </span>

                  </div>
                </td>
              </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage" let-columns>
            <tr>
                <td [attr.colspan]="3">
                  {{ assignTaskResources.nolotpresent }} "{{ selLotBrandStrainRow?.StrainName }}".
                </td>
            </tr>
          </ng-template>
      </p-table>
      </div>
    </div>
    <p-footer class="text-right">

      <button type="submit"  pButton icon="fa-check"  label="Confirm" id="btnLotSelectionConfirm" name="btnLotSelectionConfirm" ></button>
      
      <button type="button" pButton icon="fa-close" (click)="showLotSelectionModel=false" label="Cancel"></button>
  </p-footer>
</form>
</p-dialog>
<!-- </p-dialog> -->

<!-- p dialog product -->

<p-dialog header="Product Information"
[(visible)]="showProductInfoModel"
  modal="modal"
  [resizable]="true"
  [responsive]="true" [width]="400" [minWidth]="300" [blockScroll]="true">
  <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid">

    <div class="ui-g">
            <div class="ui-g-12 ui-md-6">
                 <label>
                  <strong>{{globalResource.brand}}</strong>
                 </label>
                <br>
                <label>
                   {{productTypeData?.brandName}}
                </label>
            </div>
            <div class="ui-g-12 ui-md-6">                
                  <label>
                    <strong>{{globalResource.subbrand}}</strong>
                  </label>
                  <br>
                  <label>
                    {{productTypeData?.subBrandName}}
                  </label>                   
            </div>
            <div class="ui-g-12 ui-md-6">                
                <label>
                  <strong>{{globalResource.pkgtype}}</strong>
                </label>
                <br>
                <label>
                   {{productTypeData?.pkgTypeName}}
                </label>                   
        </div>
        <div class="ui-g-12 ui-md-6">                
              <label>
                 <strong>{{globalResource.pkgsize}}</strong>
              </label>
            <br>
              <label>
                 {{productTypeData?.pkgSize}}  {{globalResource.listgramunit}}
              </label>                   
    </div>
    <div class="ui-g-12 ui-md-6">                
          <label>
            <strong>{{globalResource.strain}}</strong>
          </label>
        <br>
          <label>
             {{productTypeData?.strainName}}
          </label>                   
</div>
    </div>
    </div>

</p-dialog>

<!--<button type="text" (click)="showProductInfoModel" pButton icon="fa-external-link-square" label="Show"></button>-->
<app-lot-note [Lot]="lotInfo" *ngIf="lotInfo?.showLotNoteModal" (NoteSaved)="onNoteSave($event)" ></app-lot-note> 

<app-popup-lot-comment [Lot]="lotInfo" *ngIf="lotInfo?.showLotCommentModal" (CommentSaved)="OnCommentSaved($event)">
</app-popup-lot-comment>

<p-growl [(value)]="msgs" life='5000' ></p-growl>
</form>